<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Octanis Instruments Air Quality Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin=""/>
    
    <style>
        body{font-family: Arial, Helvetica, sans-serif;}
        .metric{font-weight: bold; font-size: 10pt;}
        td {padding: 0 3px 0 3px; text-align: center;}
        .leaflet-fade-anim .leaflet-tile,.leaflet-zoom-anim .leaflet-zoom-animated { will-change:auto !important; }
    </style>

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin=""></script>

    <script>
        //globals
        var map; 
        var nowUTCEpoch = new Date().getTime()/1000;

        //functions
        function pm2p5_to_color(pm2p5){
            //source: https://www.epa.gov/sites/production/files/2014-05/documents/zell-aqi.pdf
            var color = '#BDBDBD';
            var severity = 0;

            if(pm2p5 > 0 && pm2p5 <= 15.4){
                color = '#40FF00';
            }else if(pm2p5 > 15.5 && pm2p5 <= 40.4){
                color = '#FFFF00';
                severity = 1;
            }else if(pm2p5 > 40.5 && pm2p5 <= 65.4){
                color = '#FF8000';
                severity = 2;
            }else if(pm2p5 > 65.5 && pm2p5 <= 150.4){
                color = '#FF0000';
                severity = 3;
            }else if(pm2p5 > 150.5 && pm2p5 <= 250.4){
                color = '#B404AE';
                severity = 4;
            }else if(pm2p5 > 250.5 && pm2p5 <= 500.4){
                color = '#8A0808';
                severity = 5;
            }else if(pm2p5 > 500.5 && pm2p5 <= 999.9){
                color = '#190707';
                severity = 6;
            }

            return [severity, color];
        }

        function pm10_to_color(pm2p5){
            //source: https://www.epa.gov/sites/production/files/2014-05/documents/zell-aqi.pdf
            var color = '#BDBDBD';
            var severity = 0;

            if(pm2p5 > 0 && pm2p5 <= 54){
                color = '#40FF00';
            }else if(pm2p5 > 55 && pm2p5 <= 154){
                color = '#FFFF00';
                severity = 1;
            }else if(pm2p5 > 155 && pm2p5 <= 254){
                color = '#FF8000';
                severity = 2;
            }else if(pm2p5 > 255 && pm2p5 <= 354){
                color = '#FF0000';
                severity = 3;
            }else if(pm2p5 > 355 && pm2p5 <= 424){
                color = '#B404AE';
                severity = 4;
            }else if(pm2p5 > 425 && pm2p5 <= 604){
                color = '#8A0808';
                severity = 5;
            }else if(pm2p5 > 605 && pm2p5 <= 999.9){
                color = '#190707';
                severity = 6;

            }

            return [severity, color];
        }

        function getLocalTimeStr(utc){
            var d = new Date(utc*1000);
            return d.getDate()  + "-" + (d.getMonth()+1) 
                            + "-" + d.getFullYear() + " " + ("0" + d.getHours()).slice(-2) + ":" 
                            + ("0" + d.getMinutes()).slice(-2)
        }

        function getPopupHTML(time, pm2p5, pm10, t, h, b, f){
            return  "<h1>"+time+"</h1>"
                    + "<ul>"
                    + "<li>PM2.5: "+pm2p5+" (Severity "+pm2p5_to_color(pm2p5)[0]+")</li>"
                    + "<li>PM10: "+pm10+" (Severity "+pm10_to_color(pm10)[0]+")</li>"
                    + "<li>GPS Fix: "+f+"</li>"
                    + "<li>"+t+" ° C</li>"
                    + "<li>"+h+" % RH</li>"
                    + "</ul>";
        }

        function plotLogOnMap(log, map){    
            var isViewSet = 0;        
            Object.keys(log).sort().forEach(function(k, i) {
                if(log[k].f >= 1){
                    if(!isViewSet){
                        map.setView([log[k].lat, log[k].lon], 15);
                        isViewSet = 1;
                    }

                    var pm2p5_color = pm2p5_to_color(log[k].pm2p5);
                    var pm10_color = pm10_to_color(log[k].pm10);
                    var marker_color = (pm2p5_color[0] < pm10_color[0])? pm10_color[1] : pm2p5_color[1];
                    
                    L.circle([log[k].lat, log[k].lon], {
                        color: marker_color,
                        fillColor: marker_color,
                        fillOpacity: 0.3,
                        radius: 100
                    })
                    .bindPopup(
                        getPopupHTML(getLocalTimeStr(k), log[k].pm2p5, log[k].pm10, log[k].t, log[k].h, log[k].b, log[k].f)
                    )
                    .addTo(map);
                }
            });
        }
        function sanitizeLAT(str){
            return str/1000;
        }
        function sanitizeLON(str){
            return str/1000;
        }
        function sanitizeUTC(str){
            var now = Math.ceil(nowUTCEpoch);
            if(str > 0 && str < now){
                return str/1;
            }else{
                return NaN;
            }
        }
        function sanitizeT(str){
            return str/1;
        }
        function sanitizeH(str){
            return str/1;
        }
        function sanitizePM10(str){
            return str/10;
        }
        function sanitizePM2_5(str){
            return str/10;
        }
        function sanitizeFIX(str){
            return str/1;
        }
        function sanitizeBAT(str){
            return str/1;
        }

        function parseCSV(csv){
            var csvArr = csv.split('\n');
            var csvHead = csvArr[0].replace(/(\r\n|\n|\r)/gm, "").split(',');

            var log = {};
            var errors = 0;
            var pm2p5_avg = 0;
            var pm10_avg = 0;
            var t_avg = 0;
            var h_avg = 0;
            var min_ago = 0;
            var n = 0;

            for (let index = 0; index < csvArr.length; index++) {
                const line = csvArr[index];

                var lineArr = line.replace(/(\r\n|\n|\r)/gm, "").split(',');
                
                var lat = sanitizeLAT(lineArr[csvHead.indexOf('LAT')]);
                var lon = sanitizeLON(lineArr[csvHead.indexOf('LON')]);
                var pm2p5 = sanitizePM2_5(lineArr[csvHead.indexOf('PM2.5')]);
                var pm10 = sanitizePM10(lineArr[csvHead.indexOf('PM10')]);
                var t = sanitizeT(lineArr[csvHead.indexOf('T')]);
                var h = sanitizeH(lineArr[csvHead.indexOf('H')]);
                var b = sanitizeBAT(lineArr[csvHead.indexOf('BAT')]);
                var f = sanitizeFIX(lineArr[csvHead.indexOf('FIX')]);
                var utc = sanitizeUTC(lineArr[csvHead.indexOf('UTC')]);

                
                if((lat == 0 && lon == 0 && f == 1) || isNaN(lat) || isNaN(lon) || isNaN(pm2p5) || isNaN(pm10) || isNaN(t)
                    || isNaN(t) || isNaN(h) || isNaN(b) || isNaN(f) || isNaN(utc)){
                        errors++;
                    }else{

                        if(log[utc] == undefined){ //dedupe the CSV
                            n++;

                            log[utc] = {
                            lat:lat,
                            lon:lon,
                            pm2p5:pm2p5,
                            pm10:pm10,
                            t:t,
                            h:h,
                            b:b,
                            f:f,
                        }

                        pm2p5_avg += pm2p5;
                        pm10_avg += pm10;
                        t_avg += t;
                        h_avg += h;
                        }
               
                    }
            }

            pm2p5_avg = Math.round(pm2p5_avg/n * 10)/10;
            pm10_avg = Math.round(pm10_avg/n * 10)/10;
            t_avg = Math.round(t_avg/n * 10)/10;
            h_avg = Math.round(h_avg/n * 10)/10;
            last_utc = Object.keys(log).sort().reverse()[0];
            last_battery = log[last_utc].b;
            min_ago = Math.round((nowUTCEpoch - last_utc)/60);

            document.getElementById("t").innerHTML = t_avg + ' °C';
            document.getElementById("h").innerHTML = h_avg + ' %';
            
            document.getElementById("pm2p5").innerHTML = pm2p5_avg + ' µg/m³';
            document.getElementById("pm2p5").style.textDecoration = 'underline';
            document.getElementById("pm2p5").style.textDecorationColor = pm2p5_to_color(pm2p5_avg)[1];

            document.getElementById("pm10").innerHTML = pm10_avg + ' µg/m³';
            document.getElementById("pm10").style.textDecoration = 'underline';
            document.getElementById("pm10").style.textDecorationColor = pm10_to_color(pm10_avg)[1];


            document.getElementById("duration").innerHTML = Math.round((n * 5)/60 * 10)/10 + ' h';
            document.getElementById("metrics").style.visibility = 'visible';
            document.getElementById("status").innerHTML = last_battery +' %';
            if(min_ago < 24*7*60){
                document.getElementById("ago").innerHTML =  min_ago + ' min ago';
            }


            return log;
        }

        function handleCSV(file){
            document.getElementById("metrics").style.visibility = 'hidden';
            document.getElementById("loading").innerHTML = "please wait...";
            const reader = new FileReader();
            reader.readAsDataURL(file[0]);
            reader.onload = function(e){
                var log = parseCSV(atob(e.target.result.split(',')[1]));
                plotLogOnMap(log, map);
                document.getElementById("loading").innerHTML = "";
            }
        }

        function main(){
            map = L.map('map');
            map.setView([0,0], 1);

            L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
        }
        
    </script>
  </head>

  <body onload="main()">
    
    <header style="display:flex;justify-content:space-between;padding:10px;top:0;bottom:0;left:0;right:0;position:absolute;max-width:100%;height:40px;border-bottom: 3px solid #ffc600">
        <div style="width:140px">
            <input style="line-height: 29pt" accept="text/csv" type="file" id="csvFile" onchange="handleCSV(this.files)"/>
            <span id="loading" style="position: absolute; top:20px; left:45%;"></span>
        </div>
        
        <table id="metrics" style="visibility: hidden; width:580px;margin-top:0px;">
            <tr style="font-size: 8pt">
                <td>PM2.5</td>
                <td>PM10</td>
                <td>Temperature</td>
                <td>Rel. Humidity</td>
                <td>Average over</td>
                <td>Battery<br/><span id="ago"></span></td>
            </tr>
            <tr>
                <td><span class="metric" id="pm2p5"></span></td>
                <td><span class="metric" id="pm10"></span></td>
                <td><span class="metric" id="t"></span></td>
                <td><span class="metric" id="h"></span></td>
                <td><span class="metric" id="duration"></span></td>
                <td><span class="metric" id="status"></span></td>
            </tr>
        </table>
        
        <div style="width:140px">
            <img src="data:image/jpeg;base64,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" alt="Octanis Instrumets">
        </div>
    </header>
    <section>
        <div id="map" style="width:100%;min-height:500px;top:63px;bottom:0;left:0;right:0;position: absolute;"></div>
    </section>
  </body>
</html>